import {FacebookSendPostHandler} from '../../src/facebook/FacebookSendPostHandler';
import {TestAid} from '../env/testAid.es6';

let subject = null;
let aid = new TestAid();
let chai = require('chai');
let htmlparser = require('htmlparser2');

describe('FacebookSendPostHandler testing ', function() {

    chai.should();
    this.error = (error) => assert('Error thrown', false);

    var execute = (html) => {
        var parser = new htmlparser.Parser(subject, {recognizeSelfClosing: true});
        parser.write(html);
        parser.done();
    }

    var doTest = (done, html, expectedPost) => {
        subject = new FacebookSendPostHandler((error, data) => {

            // Validate the data
            aid.validate(expectedPost, data.compose);
            // Successful
            done();
        });
        execute(html);
    }

    describe('#parse', function () {

        it('scrape required data to upload post...', (done) => {
            let expected = {
            	action: '/composer/mbasic/?av=100009834785112&refid=7',
                fb_dtsg: 'AQExy7-cmaQJ:AQEssaHldUlA',
                target: '100009834785112',
                privacyx: '300645083384735'
            };
            let pageHtml = '<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Facebook</title><link crossorigin="use-credentials" href="/data/manifest/" rel="manifest"/></head><body class="b c d e" tabindex="0"><div class="f"><div id="viewport"><div id="toggleHeader"/><div class="g"><div class="h i" id="header"><form action="/search/" class="j k" method="get"><input name="refid" type="hidden" value="7"/><input name="search" type="hidden" value="Search"/><input name="search_source" type="hidden" value="top_nav"/><table class="l"><tbody><tr><td class="m"><a class="n o p" href="/home.php?ref_component=mbasic_home_logo&amp;ref_page=%2Fwap%2Fhome.php&amp;refid=7"><img alt="Facebook logo" class="q img" height="20" src="https://static.xx.fbcdn.net/rsrc.php/v2/ym/r/Gjhrhb7r0lb.png" width="20"/></a></td><td class="r s"><input autocomplete="off" autocorrect="off" class="t u v" name="query" placeholder="Search Facebook" spellcheck="false" type="text"/></td><td class="m"><input class="w x y z" type="submit" value="Search"/></td></tr></tbody></table></form><div class="ba"><a accesskey="1" aria-label="Home" class="bb bc" href="/home.php?a_type=sr&amp;ref_component=mbasic_home_header&amp;ref_page=%2Fwap%2Fhome.php&amp;refid=7" style="display:block;height:0;overflow:hidden;position:absolute;width:0;padding:0"/><a aria-hidden="1" class="bb bd bc" href="/home.php?ref_component=mbasic_home_header&amp;ref_page=%2Fwap%2Fhome.php&amp;refid=7" tabindex="-1">Home</a><a class="bb bc" href="/profile.php?ref_component=mbasic_home_header&amp;ref_page=%2Fwap%2Fhome.php&amp;refid=7">Profile</a><a accesskey="4" class="bb bc" href="/messages/?ref_component=mbasic_home_header&amp;ref_page=%2Fwap%2Fhome.php&amp;refid=7">Messages</a><a accesskey="3" class="bb bc" href="/notifications.php?ref_component=mbasic_home_header&amp;ref_page=%2Fwap%2Fhome.php&amp;refid=7">Notifications</a><a accesskey="6" class="bb bc" href="/buddylist.php?ref_component=mbasic_home_header&amp;ref_page=%2Fwap%2Fhome.php&amp;refid=7">Chat(4)</a><a accesskey="2" class="bb bc" href="/friends/center/mbasic/?fb_ref=tn&amp;sr=1&amp;ref_component=mbasic_home_header&amp;ref_page=%2Fwap%2Fhome.php&amp;refid=7">Friends</a><a accesskey="5" class="bb bc" href="/menu/bookmarks/?ref_component=mbasic_home_header&amp;ref_page=%2Fwap%2Fhome.php&amp;refid=7">Menu</a></div></div></div><div id="objects_container"><div class="be bf e" id="root" role="main"><div id="m_home_notice"/><div><div class="e bg bh" id="mbasic_inline_feed_composer"><form action="/composer/mbasic/?av=100009834785112&amp;refid=7" method="post"><input autocomplete="off" name="fb_dtsg" type="hidden" value="AQExy7-cmaQJ:AQEssaHldUlA"/><input name="charset_test" type="hidden" value="€,´,€,´,水,Д,Є"/><input name="privacyx" type="hidden" value="300645083384735"/><input name="target" type="hidden" value="100009834785112"/><input name="c_src" type="hidden" value="feed"/><input name="cwevent" type="hidden" value="composer_entry"/><input name="referrer" type="hidden" value="feed"/><input name="ctype" type="hidden" value="inline"/><input name="cver" type="hidden" value="amber"/><input name="rst_icv" type="hidden"/><div class="bi"><span class="bj">Share with:</span><label class="bk bl bm bn bo"><input class="w bp bq bl" name="view_privacy" type="submit" value="Public"/><div class="br"/></label></div><table class="l bs"><tbody><tr><td class="r"><div class="bt bu"><table class="l bv bw"><tbody><tr><td class="m bx"><label for="u_0_0"><a href="/profile.php?refid=7"><img alt="Skooter Martin" class="by img" height="32" src="https://scontent.fper1-1.fna.fbcdn.net/v/t1.0-1/cp0/e15/q65/p32x32/12043055_235948343409657_1968444667091118032_n.jpg?efg=eyJpIjoiYiJ9&amp;oh=2c044e17a466b5c403692bf76eb51adb&amp;oe=581941F5" width="32"/></a></label></td><td class="r bz ca"><textarea class="cb cc cd ce cf" id="u_0_0" name="xc_message" rows="2"/></td></tr></tbody></table></div></td><td class="m"><div class="cg"><input class="w x z" name="view_post" type="submit" value="Post"/></div></td></tr></tbody></table><div class="ch"><span class="ci cj ck"><div class="cl"><table class="l cm ca"><tbody><tr><td class="u m"><label class="cn" for="u_0_1"><img class="co cp img" height="12" src="https://static.xx.fbcdn.net/rsrc.php/v2/yy/r/I_6zBUdw47I.png" width="12"/></label></td><td class="u m"><input class="w cq cr cs" id="u_0_1" name="view_photo" type="submit" value="Add Photos"/></td></tr></tbody></table></div><div class="cl"><table class="l cm ca"><tbody><tr><td class="u m"><label class="cn" for="u_0_2"><img class="co cp img" height="12" src="https://static.xx.fbcdn.net/rsrc.php/v2/yH/r/H7R1sIfGmOU.png" width="12"/></label></td><td class="u m"><input class="w cq cr cs" id="u_0_2" name="view_overview" type="submit" value="More"/></td></tr></tbody></table></div></span></div></form></div></div><div class="e ct cu"><div class="cv cw"><div><a class="cx" href="/a/notifications.php?seennotification=1468733522672493%2C1468237059288777&amp;gfid=AQBP_0x6VA8dMg-H&amp;refid=7">Clear Notifications</a></div></div></div><div id="m_newsfeed_stream"><div class="cy"/><div id="m-top-of-feed"/><div class="cz da db"><div class="cv cw dc" id="u_0_3"><div><div><h3 class="dd de"><strong><a href="/therealcrediblehulk/?refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362&amp;__tn__=C">The Credible Hulk</a></strong>shared <a href="/SkepticalMemeSociety/?refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362&amp;__tn__=C">Skeptical Meme Society</a>\'s <a href="/SkepticalMemeSociety/photos/a.199409663545589.1073741826.199409080212314/642748339211717/?type=3&amp;refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362&amp;__tn__=C">photo</a>.</h3></div><div class="df"><span><p>I knew there was a good reason I always liked Groucho Marx. <img alt="grin emoticon" class="img" height="16" src="https://static.xx.fbcdn.net/rsrc.php/v2/yH/r/SOe5wIZyutW.png" width="16"/></p></span></div><div class="dg"><div class="cv cw dc dh" id="u_0_4"><div><h3 class="dd di"><a href="/SkepticalMemeSociety/?refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362&amp;__tn__=C">Skeptical Meme Society</a></h3><div class="df"><span><p>Reads best if you actually imagine it being said in Groucho\'s voice.</p></span></div><div class="dg"><div class="dj dk"><a class="dl dm dn" href="/SkepticalMemeSociety/photos/a.199409663545589.1073741826.199409080212314/642748339211717/?type=3&amp;refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362&amp;__tn__=E"><img class="img" height="200" src="https://scontent.fper1-1.fna.fbcdn.net/v/t1.0-0/cp0/e15/q65/s200x200/13718611_642748339211717_8996839694404381171_n.jpg?efg=eyJpIjoiYiJ9&amp;oh=6441c0491c0213b2085b6fa0691c7a79&amp;oe=57EC0C54" width="163"/></a></div></div></div></div></div></div><div class="do"><div class="cj ck"><abbr>Yesterday at 6:00am</abbr><span aria-hidden="true">· </span><span class="dp"><span><span class="cj">Public</span></span></span></div><div class="cj ck"><span class="cj ck"><a aria-label="Likes" class="dq dr" href="/story.php?story_fbid=1218714244826558&amp;id=892778157420170&amp;refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362"><img class="ds img" height="9" src="https://static.xx.fbcdn.net/rsrc.php/v2/ya/r/FVWZGFsk3kW.png" width="10"/>845</a><span aria-hidden="true">· </span><a href="/a/like.php?ul&amp;tab=h_nor&amp;actionsource=feed&amp;ft_ent_identifier=1218714244826558&amp;av=100009834785112&amp;gfid=AQCO__pwtHAa_g_I&amp;refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362">Like</a></span><span aria-hidden="true">· </span><a class="dr" href="/story.php?story_fbid=1218714244826558&amp;id=892778157420170&amp;refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362">22 Comments</a><span aria-hidden="true">· </span><a href="/composer/mbasic/?c_src=share&amp;referrer=feed&amp;target=100009834785112&amp;sid=642748339211717&amp;m=self&amp;exit_uri=https%3A%2F%2Fmbasic.facebook.com%2Fhome.php&amp;cwevent=composer_entry&amp;av=100009834785112&amp;view_overview&amp;refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362">Share</a><span aria-hidden="true">· </span><a href="/story.php?story_fbid=1218714244826558&amp;id=892778157420170&amp;bacr=1469152377%3A1469152377%3A1%3A-5224776366230527362%3A1469052016%3A0&amp;refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362#footer_action_list">Full Story</a><span aria-hidden="true">· </span><a href="/nfx/basic/direct_actions/?context_str=%7B%22breadcrumbs%22%3A%5B%5D%2C%22story_location%22%3A%22feed%22%2C%22is_from_feed_tombstone%22%3Afalse%2C%22actions_taken%22%3A%22%22%2C%22hideable_token%22%3A%22BcExCsAwCADAL6lotXPpC_KAkiGQLgri0sW39w4JTZGJ2egQsb69xp65rlyz3vBRkV-3naRqKMoEqND78ciG_gE%22%2C%22story_permalink_token%22%3A%22S%3A_I892778157420170%3A1218714244826558%22%7D&amp;redirect_uri=%2Fstories.php%3Ftab%3Dh_nor&amp;refid=7&amp;_ft_=qid.6309961413270181917%3Amf_story_key.-5224776366230527362">More</a></div></div></div><div class="ee ef eg eh ei"><a href="/stories.php?aftercursorr=1469152037%3A1469152037%3A5%3A-5778465749634641988%3A1469131632%3A0&amp;tab=h_nor&amp;__m_log_async__=1&amp;refid=7"><span>See More Stories</span></a></div></div></div></div></div></div></body></html>';

            // Undertake test
            doTest(done, pageHtml, expected);
        });
    });
});
